const prettier = require('prettier')
const util = require('./util')
const { VariableType } = require('./enum')

const empty = `// No HTTP/HTTPS transactions have been recorded`
const staticImports = [ './postman-shim.js' ]

function render (result) {
  if (!result.main.length) {
    return empty
  }
  const raw = [
    header(),
    imports(result),
    options(result),
    scope(result),
    logic(result)
  ].filter(section => section).join(`\n\n`)
  return prettier.format(raw, { semi: true, parser: 'babel' })
}

function header () {
  return `// Auto-generated by the Load Impact converter`
}

function imports (result) {
  const direct = []
  const indirect = {}
  for (const [ name, spec ] of result.imports) {
    if (typeof spec === 'object') {
      const { base } = spec
      if (!(base in indirect)) {
        indirect[base] = []
      }
      indirect[base].push(name)
    } else {
      direct.push([ name, spec ])
    }
  }
  const lines = []
  for (const path of staticImports) {
    lines.push(staticImport(path))
  }
  for (const [ name, path ] of direct) {
    lines.push(imp(name, path))
  }
  for (const key of Object.keys(indirect)) {
    const name = `{ ${indirect[key].join(`, `)} }`
    lines.push(imp(name, key))
  }
  return lines.join(`\n`)
}

function staticImport (path) {
  return `import ${JSON.stringify(path)};`
}

function imp (name, path) {
  return `import ${name} from ${JSON.stringify(path)};`
}

function options (result) {
  if (!Object.keys(result.options).length) {
    return null
  }
  return `export let options = ${JSON.stringify(result.options)};`
}

function scope (result) {
  const lines = []
  lines.push(`const Scope = Symbol.for("scope");`)
  lines.push(`const Var = Symbol.for("variable");`)
  const initial = [
    globalScope(result),
    collectionScope(result),
    environmentScope(result)
  ].filter(item => item)
  const args = scopeArgs(initial)
  lines.push(`postman[Scope](${args});`)
  return lines.join(`\n`)
}

function globalScope (result) {
  if (result.scope.global.size) {
    return `global: ${vars(result.scope.global)}`
  } else {
    return null
  }
}

function collectionScope (result) {
  if (result.scope.collection.size) {
    return `collection: ${vars(result.scope.collection)}`
  } else {
    return null
  }
}

function environmentScope (result) {
  if (result.scope.environment.size) {
    return `environment: ${vars(result.scope.environment)}`
  } else {
    return null
  }
}

function scopeArgs (initial) {
  if (initial.length) {
    return `{
${util.indent(initial.join(`,\n`))}
}`
  } else {
    return ``
  }
}

function logic (result) {
  return `export default function() {
${util.indent(body(result))}
}
`
}

function body (spec) {
  return [
    declares(spec),
    main(spec)
  ].filter(section => section).join(`\n\n`)
}

function vars (spec) {
  const items = []
  for (const item of spec) {
    if (item[1] === undefined) {
      continue
    }
    const name = JSON.stringify(item[0])
    const value = varValue(item[1])
    items.push(`${name}: ${value}`)
  }
  return `{
${util.indent(items.join(`,\n`))}
}`
}

function varValue (spec) {
  switch (spec.type) {
    case VariableType.Boolean:
    case VariableType.Number:
    case VariableType.Literal:
      return spec.value
    case VariableType.Json:
    case VariableType.String:
      return JSON.stringify(spec.value)
    default:
      throw new Error(`Unrecognized variable type: ${spec.type}`)
  }
}

function declares (spec) {
  if (!spec.declares.size) {
    return null
  }
  return `let ${[ ...spec.declares ].join(`, `)};`
}

function main (spec) {
  return spec.main.map(item => chunk(item)).join(`\n\n`)
}

function chunk (item) {
  if (!item) {
    return ``
  }
  const type = typeof item
  switch (type) {
    case 'string':
      return item
    case 'object':
      if (Array.isArray(item)) {
        return item.join(`\n`)
      } else {
        return group(item)
      }
    default:
      throw new Error('Invalid chunk type: ' + type)
  }
}

function group (spec) {
  return `group(${JSON.stringify(spec.name)}, function () {
${util.indent(body(spec))}
});`
}

module.exports = render
